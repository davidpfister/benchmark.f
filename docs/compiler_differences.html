<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class="dark-mode">
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="author" content="SXS Collaboration">
    <meta name="generator" content="Doxygen 1.12.0"/>
  <title>Benchmark: Compiler Differences</title>
  <link href="tabs.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
  <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
  <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
  <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
  <script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
  <script type="text/javascript">
      DoxygenAwesomeFragmentCopyButton.init()
      DoxygenAwesomeDarkModeToggle.init()
      DoxygenAwesomeParagraphLink.init()
      DoxygenAwesomeInteractiveToc.init()
      DoxygenAwesomeTabs.init()
  </script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="./mathjax/MathJax.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="devibeans.css">
  <script src="highlight.js"></script>
<script>
$(function() {
	hljs.configure({useBR: false});
	$(".fragment").each(function(i,node) {
		$(node).removeClass("fragment");
		hljs.highlightBlock(node);
	});
});
</script>
  </head>
  <body>
  <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
  <div id="titlearea">
    <table cellspacing="0" cellpadding="0">
      <tbody>
        <tr style="height: 56px;">
          <td id="projectlogo"><img alt="Logo" src="hare.png" /></td>
          <td id="projectalign" style="padding-left: 0.5em;">
            <div id="projectname">
              <a href="index.html">Benchmark</a>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('compiler_differences.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Compiler Differences</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__c_1_2_users_2dev_2_documents_2_git_hub_2sandbox_2benchmark_8f_2_8dox_2articles_2_compilers"></a></p>
<p>While developing this library I experienced some differences between compilers (i.e. ifort and gfortran). Not in terms of performances, which is kind of expected, but in terms of implementation of some modern Fortran features. The <em>benchmark.f</em> library uses some dark corner of the Fortran language to get some kind of generic programming. As a consequence, it seams that different compilers have various interpretation of these edge cases in the standard. The developers of the f18 fortran compiler already compiled a <a href="https://github.com/klausler/fortran-wringer-tests">list</a> of features that, even-though standard-conformant, are not portable due to different interpretation of the standard. Some of the code used here is part of this list and I will do my best to provide workaround to make it work on both tested compilers.</p>
<h1><a class="anchor" id="autotoc_md5"></a>
Implicit procedure pointer</h1>
<p>Since Fortran 2003, it is possible to declare procedure pointers as function argument. The declaration is usually something like this </p><div class="fragment"><div class="line"><span class="keywordtype">procedure</span>(interface), <span class="keywordtype">intent(in)</span> :: ptr</div>
</div><!-- fragment --><p> It is also possible to omit the interface in the procedure declaration statement. <code>procedure()</code> with no type or interface name is supposed to work as a dummy procedure or procedure pointer that can handle either a function or a subroutine, so long as it isn't referenced. Many compilers assume that it means a subroutine, or just can't deal with it. gfortran is one of them.</p>
<p>While this works fine with ifort, gfortran does not accept the use of <code>function</code>s as argument. Therefore, when using gfortran, you are limited to benchmarking <code>subroutine</code>s.</p>
<h1><a class="anchor" id="autotoc_md6"></a>
Associate and unlimited polymorphism</h1>
<p>Procedure arguments are stored for later use as unlimited polymorphic variables (<code>class(*)</code>). When used in combination with the <code>associate</code> construct ifort and gfortran behave differently.</p>
<p>While ifort is capable of implicitly casting the variable into the desired type, gfortran doesn't and there one is forced to use the <code>select type</code> construct.</p>
<p>For instance, one can try this simple function call:</p>
<div class="fragment"><div class="line"><span class="comment">class(*), intent(in)            :: a1</span></div>
<div class="line"> </div>
<div class="line">associate(arg1 =&gt; a1)</div>
<div class="line">    <span class="keyword">call </span>func(arg1)</div>
<div class="line"><span class="keyword">end </span>associate</div>
</div><!-- fragment --><p>with the function </p><div class="fragment"><div class="line"><span class="keyword">subroutine </span>func(n)</div>
<div class="line">    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: n</div>
<div class="line">    print*, n</div>
<div class="line"><span class="keyword">end subroutine</span></div>
</div><!-- fragment --><p>The argument <code>n</code> is the desired integer value when the code is compiled with ifort, while gfortran returns a random value(maybe the address of the variable?)</p>
<h1><a class="anchor" id="autotoc_md7"></a>
Writing namelist to internal file</h1>
<p>gfortran does not support writing <code>namelist</code> to internal files. As such the option is only available when compiled with ifort. Preprocessor macros and conditional compilation are used to provide this option to ifort </p><div class="fragment"><div class="line"><span class="preprocessor">#ifdef __INTEL_COMPILER</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keyword">subroutine </span>benchmark_serialize_to_string(this, str)</div>
<div class="line">        <span class="keywordtype">class</span>(runner), <span class="keywordtype">intent(in)</span>, <span class="keywordtype">target</span>       :: this</div>
<div class="line">        <span class="keywordtype">character(:)</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">intent(out)</span>  :: str</div>
<div class="line">        <span class="comment">!private</span></div>
<div class="line">        <span class="keywordtype">type</span>(runner), <span class="keywordtype">pointer</span> :: bench =&gt; null()</div>
<div class="line">        namelist / config / bench</div>
<div class="line">        <span class="keyword">allocate</span>(<span class="keywordtype">character(100)</span> :: str)</div>
<div class="line">            </div>
<div class="line">        bench =&gt; this</div>
<div class="line">                 </div>
<div class="line">        <span class="keyword">write</span>(str, nml=config)</div>
<div class="line">            </div>
<div class="line">        str = trim(str)</div>
<div class="line">        <span class="keyword">nullify</span>(bench)</div>
<div class="line">    <span class="keyword">end subroutine</span></div>
<div class="line">#endif</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md8"></a>
Example</h1>
<p>Here is an example that illustrate how the same benchmark can be written for both compilers:</p>
<p>The test program is the same, irrespective of the compiler used. </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;benchmark.inc&gt;</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">program</span> poisson</div>
<div class="line">    <span class="keywordtype">use </span>rhofunc</div>
<div class="line">    <span class="keywordtype">use </span>benchmark_library</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">implicit none</span></div>
<div class="line">    </div>
<div class="line">    block</div>
<div class="line">        <span class="keywordtype">type</span>(runner) :: br</div>
<div class="line"> </div>
<div class="line">        benchmark(br, run(1.0d-6, 30, poisson_optimized))</div>
<div class="line">    <span class="keyword">end </span>block</div>
<div class="line">    <span class="keyword">read</span>(*,*)</div>
<div class="line"><span class="keyword">end program</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md9"></a>
gfortran</h2>
<div class="fragment"><div class="line"><span class="keywordtype">pure</span> <span class="keyword">subroutine </span>poisson_optimized(treshold, m)</div>
<div class="line">    <span class="keywordtype">class</span>(*), <span class="keywordtype">intent(in)</span> :: treshold</div>
<div class="line">    <span class="keywordtype">class</span>(*), <span class="keywordtype">intent(in)</span>  :: m</div>
<div class="line">    cast(treshold, real(rp))</div>
<div class="line">        cast(m, integer)</div>
<div class="line">            block</div>
<div class="line">                <span class="comment">!private</span></div>
<div class="line">                <span class="keywordtype">integer</span> :: i,j, iter</div>
<div class="line"><span class="keywordtype">                real</span>(rp) :: delta, phiprime(m,m), phi(m,m), a2, rhoarr(m<span class="comment">,m)</span></div>
<div class="line"><span class="comment"></span><span class="keywordtype">                real</span>(rp), <span class="keywordtype">parameter</span> :: quart = 0.25_rp</div>
<div class="line"> </div>
<div class="line">                delta = 1.0_rp</div>
<div class="line">                iter = 0</div>
<div class="line">                phiprime(:,:) = 0.0_rp</div>
<div class="line">                phi(:,:) = 0.0_rp</div>
<div class="line">                <span class="keywordflow">do</span> i=1, m</div>
<div class="line">                    <span class="keywordflow">do</span> j=1, m</div>
<div class="line">                        rhoarr(i,j) = rho(i*a,j*a)</div>
<div class="line"><span class="keywordflow">                    end do</span></div>
<div class="line"><span class="keywordflow">                end do</span></div>
<div class="line">            </div>
<div class="line">                <span class="keywordflow">do</span> <span class="keywordflow">while</span> (delta &gt; treshold )</div>
<div class="line">                    iter = iter + 1</div>
<div class="line">                    a2 = a**2</div>
<div class="line">                    <span class="keywordflow">do</span> i=2, m-1</div>
<div class="line">                        <span class="keywordflow">do</span> j=2, m-1</div>
<div class="line">                            phiprime(i,j) = (phi(i+1,j) + phi(i-1,j) + phi<span class="comment">(i,j+1) + phi(i,j-1))*quart &amp;</span></div>
<div class="line"><span class="comment"></span>                            + a2*quart/epsilon0*rhoarr(i,j)</div>
<div class="line"><span class="keywordflow">                        end do</span></div>
<div class="line"><span class="keywordflow">                    end do</span></div>
<div class="line">                    delta = maxval(abs(phiprime - phi))</div>
<div class="line">                    phi = phiprime </div>
<div class="line"><span class="keywordflow">                end do</span></div>
<div class="line">            <span class="keyword">end </span>block</div>
<div class="line">        endcast</div>
<div class="line">    endcast</div>
<div class="line"><span class="keyword">end subroutine</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">pure</span> <span class="keyword">real(rp) </span><span class="keyword">function </span>rho(x,y)</div>
<div class="line"><span class="keywordtype">    real</span>(rp), <span class="keywordtype">intent(in)</span> :: x,y</div>
<div class="line">    <span class="keywordflow">if</span> (x &gt; 0.6_rp .and. x &lt; 0.8_rp .and. y &gt; 0.6_rp .and. y &lt; 0.8_rp) <span class="keywordflow">then</span></div>
<div class="line">        rho = 1.0_rp</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x &gt; 0.2_rp .and. x &lt; 0.4_rp .and. y &gt; 0.2_rp .and. y &lt; 0.4_rp<span class="comment">) </span><span class="keywordflow">then</span></div>
<div class="line">        rho = -1.0_rp</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        rho = 0.0_rp</div>
<div class="line"><span class="keywordflow">    end if</span></div>
<div class="line"><span class="keyword">end function</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md10"></a>
ifort</h2>
<div class="fragment"><div class="line"><span class="keywordtype">pure</span> <span class="keyword">subroutine </span>poisson_optimized(treshold, m)</div>
<div class="line"><span class="keywordtype">    real</span>(rp), <span class="keywordtype">intent(in)</span> :: treshold</div>
<div class="line">    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span>  :: m</div>
<div class="line">    <span class="comment">!private</span></div>
<div class="line">    <span class="keywordtype">integer</span> :: i,j, iter</div>
<div class="line"><span class="keywordtype">    real</span>(rp) :: delta, phiprime(m,m), phi(m,m), a2, rhoarr(m,m)</div>
<div class="line"><span class="keywordtype">    real</span>(rp), <span class="keywordtype">parameter</span> :: quart = 0.25_rp</div>
<div class="line"> </div>
<div class="line">    delta = 1.0_rp</div>
<div class="line">    iter = 0</div>
<div class="line">    phiprime(:,:) = 0.0_rp</div>
<div class="line">    phi(:,:) = 0.0_rp</div>
<div class="line">    <span class="keywordflow">do</span> i=1, m</div>
<div class="line">        <span class="keywordflow">do</span> j=1, m</div>
<div class="line">            rhoarr(i,j) = rho(i*a,j*a)</div>
<div class="line"><span class="keywordflow">        end do</span></div>
<div class="line"><span class="keywordflow">    end do</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span> <span class="keywordflow">while</span> (delta &gt; treshold )</div>
<div class="line">        iter = iter + 1</div>
<div class="line">        a2 = a**2</div>
<div class="line">        <span class="keywordflow">do</span> i=2, m-1</div>
<div class="line">            <span class="keywordflow">do</span> j=2, m-1</div>
<div class="line">                phiprime(i,j) = (phi(i+1,j) + phi(i-1,j) + phi(i,j+1) + phi<span class="comment">(i,j-1))*quart &amp;</span></div>
<div class="line"><span class="comment"></span>                + a2*quart/epsilon0*rhoarr(i,j)</div>
<div class="line"><span class="keywordflow">            end do</span></div>
<div class="line"><span class="keywordflow">        end do</span></div>
<div class="line">        delta = maxval(abs(phiprime - phi))</div>
<div class="line">        phi = phiprime </div>
<div class="line"><span class="keywordflow">    end do</span></div>
<div class="line"><span class="keyword">end subroutine</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">pure</span> <span class="keyword">real(rp) </span><span class="keyword">function </span>rho(x,y)</div>
<div class="line"><span class="keywordtype">    real</span>(rp), <span class="keywordtype">intent(in)</span> :: x,y</div>
<div class="line">    <span class="keywordflow">if</span> (x &gt; 0.6_rp .and. x &lt; 0.8_rp .and. y &gt; 0.6_rp .and. y &lt; 0.8_rp) <span class="keywordflow">then</span></div>
<div class="line">        rho = 1.0_rp</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x &gt; 0.2_rp .and. x &lt; 0.4_rp .and. y &gt; 0.2_rp .and. y &lt; 0.4_rp<span class="comment">) </span><span class="keywordflow">then</span></div>
<div class="line">        rho = -1.0_rp</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        rho = 0.0_rp</div>
<div class="line"><span class="keywordflow">    end if</span></div>
<div class="line"><span class="keyword">end function</span></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="articles.html">Related Pages</a></li>
    <li class="footer">
    &copy; Copyright 2017 - 2024
    <a href="LICENSE.txt" target="_blank">
    <span class="hidden-xs">Distributed under the</span>
    MIT License</a>
  </ul>
</div>
</body>
</html>
